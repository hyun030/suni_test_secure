- ë§¤ì¶œì•¡ ê¸°ì¤€ ì—…ê³„ ìµœëŒ€ ê·œëª¨ë¡œ ì›ê°€ ê²½ìŸë ¥ í™•ë³´
- ëŒ€ê·œëª¨ ì„¤ë¹„ íˆ¬ìë¥¼ í†µí•œ íš¨ìœ¨ì„± ê·¹ëŒ€í™”

### 2. ìˆ˜ìµì„± ìš°ìœ„ ìš”ì†Œ
- ì˜ì—…ì´ìµë¥ ì—ì„œ ì¼ê´€ëœ ì—…ê³„ ë¦¬ë”ì‹­ ìœ ì§€
- ì œí’ˆ ë¯¹ìŠ¤ ìµœì í™”ë¥¼ í†µí•œ ë§ˆì§„ ê°œì„  íš¨ê³¼

## ê°œì„  ê³¼ì œ
* ë³€ë™ë¹„ ê´€ë¦¬ ì²´ê³„ ê³ ë„í™”ë¥¼ í†µí•œ ì¶”ê°€ ë§ˆì§„ í™•ë³´
* ì¹œí™˜ê²½ ì‚¬ì—… í¬íŠ¸í´ë¦¬ì˜¤ í™•ëŒ€ ê²€í†  í•„ìš”""" ìµœëŒ€ ê·œëª¨ë¡œ ì›ê°€ ê²½ìŸë ¥ í™•ë³´
- ëŒ€ê·œëª¨ ì„¤ë¹„ íˆ¬ì íš¨ìœ¨ì„± ê·¹ëŒ€í™”

### 2. ìˆ˜ìµì„± ìš°ìœ„ ìš”ì†Œ
- ì˜ì—…ì´ìµë¥ ì—ì„œ ì¼ê´€ëœ ì—…ê³„ ë¦¬ë”ì‹­ ìœ ì§€
- ì œí’ˆ ë¯¹ìŠ¤ ìµœì í™”ë¥¼ í†µí•œ ë§ˆì§„ ê°œì„ 

## ê°œì„  ê³¼ì œ
* ë³€ë™ë¹„ ê´€ë¦¬ ì²´ê³„ ê³ ë„í™” í•„ìš”
* ì¹œí™˜ê²½ ì‚¬ì—… í¬íŠ¸í´ë¦¬ì˜¤ í™•ëŒ€ ê²€í† """
    
    if not news_insight:
        news_insight = """# ë‰´ìŠ¤ ë¶„ì„ ì¢…í•©

## ê¸ì •ì  ì‹œì¥ ë™í–¥
* 3ë¶„ê¸° ì‹¤ì  í˜¸ì¡°ë¡œ íˆ¬ìì ì‹ ë¢°ë„ ì œê³ 
* ì›ìœ ê°€ ì•ˆì •í™”ë¡œ ì •ìœ  ë§ˆì§„ ê°œì„  í™˜ê²½ ì¡°ì„±
* ì•„ì‹œì•„ ì§€ì—­ ì •ìœ  ë§ˆì§„ ê³„ì ˆì  ìƒìŠ¹ì„¸ ì§€ì†

## ì „ëµì  ì´ìŠˆ ë° ëŒ€ì‘
### 1. ì‚¬ì—… êµ¬ì¡° ê°œí¸
- ë°°í„°ë¦¬ ì‚¬ì—… ë¶„í• ì„ í†µí•œ í•µì‹¬ ì—­ëŸ‰ ì§‘ì¤‘
- í¬íŠ¸í´ë¦¬ì˜¤ ìµœì í™”ë¡œ ìì› ë°°ë¶„ íš¨ìœ¨ì„± ì œê³ 

### 2. ì •ì±… í™˜ê²½ ë³€í™”
- ì—ë„ˆì§€ ì „í™˜ ì •ì±…ì— ëŒ€í•œ ì„ ì œì  ëŒ€ì‘ í•„ìš”
- íƒ„ì†Œì¤‘ë¦½ ë¡œë“œë§µì— ë”°ë¥¸ ì‚¬ì—… ì „ëµ ì¡°ì •

## ë¦¬ìŠ¤í¬ ìš”ì¸
* ê¸€ë¡œë²Œ ì—ë„ˆì§€ ì‹œì¥ ë³€ë™ì„± í™•ëŒ€
* í™˜ê²½ ê·œì œ ê°•í™”ë¡œ ì¸í•œ ì¶”ê°€ íˆ¬ì ë¶€ë‹´"""
    
    if not integrated_insight:
        integrated_insight = """# í†µí•© ë¶„ì„ ê²°ê³¼ (Executive Summary)

## ì¢…í•© í‰ê°€
SKì—ë„ˆì§€ëŠ” ê²¬ê³ í•œ ì¬ë¬´ ì„±ê³¼ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì—…ê³„ ë¦¬ë”ì‹­ì„ ìœ ì§€í•˜ê³  ìˆìœ¼ë‚˜, ì—ë„ˆì§€ ì „í™˜ ì‹œëŒ€ì— ëŒ€ì‘í•œ ì „ëµì  í˜ì‹ ì´ í•„ìš”í•œ ì‹œì ì…ë‹ˆë‹¤.

## ì „ëµì  ë°©í–¥ì„±

### 1. ë‹¨ê¸° ì „ëµ (1-2ë…„)
* **ìš´ì˜ íš¨ìœ¨ì„± ê·¹ëŒ€í™”**
  - ì›ê°€ ì ˆê° í”„ë¡œê·¸ë¨ ê°•í™”
  - ê³µì • ìµœì í™”ë¥¼ í†µí•œ ë§ˆì§„ í™•ëŒ€
  - í˜„ê¸ˆ ì°½ì¶œ ëŠ¥ë ¥ í–¥ìƒ

### 2. ì¤‘ê¸° ì „ëµ (3-5ë…„)
* **ì‚¬ì—… í¬íŠ¸í´ë¦¬ì˜¤ ì¬í¸**
  - í•µì‹¬ ì‚¬ì—… ê²½ìŸë ¥ ê°•í™”
  - ì‹ ì„±ì¥ ë™ë ¥ ë°œêµ´ ë° íˆ¬ì
  - ë””ì§€í„¸ í˜ì‹  ê°€ì†í™”

### 3. ì¥ê¸° ì „ëµ (5ë…„ ì´ìƒ)
* **ì§€ì†ê°€ëŠ¥ ì„±ì¥ ê¸°ë°˜ êµ¬ì¶•**
  - ì¹œí™˜ê²½ ì—ë„ˆì§€ ì‚¬ì—… ì§„ì¶œ
  - ESG ê²½ì˜ ì²´ê³„ ê³ ë„í™”
  - ê¸€ë¡œë²Œ ì‹œì¥ í™•ì¥

## í•µì‹¬ ì‹¤í–‰ ê³¼ì œ
1. **ì •ìœ  ì‚¬ì—… ê²½ìŸë ¥ ê°•í™”**: ì›ê°€ ê²½ìŸë ¥ í™•ë³´ ë° ì œí’ˆ ì°¨ë³„í™”
2. **ì‹ ì‚¬ì—… ê¸°íšŒ í¬ì°©**: ìˆ˜ì†ŒÂ·ì‹ ì¬ìƒì—ë„ˆì§€ ë“± ë¯¸ë˜ ì—ë„ˆì§€ ì‹œì¥ ì§„ì¶œ
3. **ì¡°ì§ ì—­ëŸ‰ ê°•í™”**: ë””ì§€í„¸ ì „í™˜ ë° ì¸ì¬ í™•ë³´ë¥¼ í†µí•œ ì¡°ì§ ê²½ìŸë ¥ ì œê³ """
    
    print("âœ… ëª¨ë“  ë°ì´í„° ì—°ë™ ì ê²€ ì™„ë£Œ")
    
    return {
        'financial_df': financial_df,
        'gap_df': gap_df,
        'news_df': news_df,
        'financial_insight': financial_insight,
        'news_insight': news_insight,
        'integrated_insight': integrated_insight
    }


# --------------------------
# 7. ì™„ì „ ìˆ˜ì •ëœ PDF ìƒì„± í•¨ìˆ˜
# --------------------------
def create_completely_fixed_pdf_report(
    financial_data=None,
    news_data=None,
    insights=None,
    show_footer=True,
    report_target="SKì´ë…¸ë² ì´ì…˜ ê²½ì˜ì§„",
    report_author="AI ë¶„ì„ ì‹œìŠ¤í…œ",
    **kwargs
):
    """ëª¨ë“  ë¬¸ì œê°€ ì™„ì „íˆ í•´ê²°ëœ PDF ë³´ê³ ì„œ ìƒì„±"""
    
    try:
        print("ğŸš€ ì™„ì „ ìˆ˜ì •ëœ PDF ë³´ê³ ì„œ ìƒì„± ì‹œì‘...")
        
        # 1. í•œê¸€ í°íŠ¸ ì„¤ì •
        registered_fonts = setup_korean_fonts()
        
        # 2. ë°ì´í„° ì—°ë™ ì ê²€ ë° ê°€ì ¸ì˜¤ê¸°
        data = get_verified_session_data()
        
        # 3. 4ê°œ ì°¨íŠ¸ ìƒì„± (ì •ë°©í–¥, ë°ì´í„° ì—°ë™)
        charts = create_four_correct_charts(data['financial_df'], data['gap_df'])
        
        # 4. ìŠ¤íƒ€ì¼ ì •ì˜
        styles = getSampleStyleSheet()
        
        TITLE_STYLE = ParagraphStyle(
            'CompanyTitle',
            fontName=registered_fonts.get('KoreanBold', 'Helvetica-Bold'),
            fontSize=18,
            leading=24,
            spaceAfter=20,
            alignment=1,
            textColor=colors.HexColor('#1F4E79')
        )
        
        SECTION_STYLE = ParagraphStyle(
            'SectionTitle',
            fontName=registered_fonts.get('KoreanBold', 'Helvetica-Bold'),
            fontSize=15,
            leading=20,
            textColor=colors.HexColor('#E31E24'),
            spaceBefore=16,
            spaceAfter=12,
        )
        
        SUB_SECTION_STYLE = ParagraphStyle(
            'SubSectionTitle',
            fontName=registered_fonts.get('KoreanBold', 'Helvetica-Bold'),
            fontSize=12,
            leading=16,
            textColor=colors.HexColor('#2C3E50'),
            spaceBefore=10,
            spaceAfter=8,
        )
        
        BODY_STYLE = ParagraphStyle(
            'BodyText',
            fontName=registered_fonts.get('Korean', 'Helvetica'),
            fontSize=10,
            leading=14,
            spaceAfter=4,
            textColor=colors.black
        )
        
        # 5. PDF ë¬¸ì„œ ìƒì„±
        buffer = io.BytesIO()
        doc = SimpleDocTemplate(
            buffer,
            pagesize=A4,
            leftMargin=2*cm,
            rightMargin=2*cm,
            topMargin=2.5*cm,
            bottomMargin=2.5*cm
        )
        
        story = []
        
        # í‘œì§€
        story.append(Paragraph("SKì—ë„ˆì§€ ì¢…í•© ë¶„ì„ ë³´ê³ ì„œ", TITLE_STYLE))
        story.append(Paragraph("ì†ìµê°œì„ ì„ ìœ„í•œ ê²½ìŸì‚¬ ë¹„êµ ë¶„ì„", TITLE_STYLE))
        story.append(Spacer(1, 30))
        
        # ë³´ê³ ì„œ ì •ë³´
        info_table_data = [
            ['ë³´ê³ ì¼ì', datetime.now().strftime('%Yë…„ %mì›” %dì¼')],
            ['ë³´ê³ ëŒ€ìƒ', clean_text_for_pdf(report_target)],
            ['ë³´ê³ ì', clean_text_for_pdf(report_author)]
        ]
        info_table = Table(info_table_data, colWidths=[4*cm, 8*cm])
        info_table.setStyle(TableStyle([
            ('FONTNAME', (0, 0), (-1, -1), registered_fonts.get('Korean', 'Helvetica')),
            ('FONTSIZE', (0, 0), (-1, -1), 11),
            ('ALIGN', (0, 0), (0, -1), 'RIGHT'),
            ('ALIGN', (1, 0), (1, -1), 'LEFT'),
            ('VALIGN', (0, 0), (-1, -1), 'MIDDLE'),
            ('LEFTPADDING', (0, 0), (-1, -1), 10),
            ('RIGHTPADDING', (0, 0), (-1, -1), 10),
            ('TOPPADDING', (0, 0), (-1, -1), 8),
            ('BOTTOMPADDING', (0, 0), (-1, -1), 8),
        ]))
        story.append(info_table)
        story.append(Spacer(1, 40))
        
        # ==================== 1. ì¬ë¬´ë¶„ì„ ê²°ê³¼ ====================
        story.append(Paragraph("1. ì¬ë¬´ë¶„ì„ ê²°ê³¼", SECTION_STYLE))
        story.append(Spacer(1, 10))
        
        # 1-1. ì¬ë¬´ì§€í‘œ í‘œ
        story.append(Paragraph("1-1. ì •ë¦¬ëœ ì¬ë¬´ì§€í‘œ (í‘œì‹œê°’)", SUB_SECTION_STYLE))
        story.append(Spacer(1, 6))
        
        if data['financial_df'] is not None:
            financial_table = create_properly_sized_table(
                data['financial_df'], registered_fonts, '#E6F3FF'
            )
            if financial_table:
                story.append(financial_table)
        
        story.append(Spacer(1, 16))
        
        # 1-1-1. ë¶„ê¸°ë³„ íŠ¸ë Œë“œ ì°¨íŠ¸
        story.append(Paragraph("1-1-1. ë¶„ê¸°ë³„ ë§¤ì¶œì•¡ íŠ¸ë Œë“œ ë¶„ì„", SUB_SECTION_STYLE))
        story.append(Spacer(1, 6))
        
        trend_chart_img = safe_chart_to_image(charts.get('trend'), width=500, height=300)
        if trend_chart_img:
            story.append(trend_chart_img)
        else:
            story.append(Paragraph("ğŸ“Š ì°¨íŠ¸ ìƒì„± ë¶ˆê°€ - ì‹œìŠ¤í…œ ì œì•½", BODY_STYLE))
        
        story.append(Spacer(1, 16))
        
        # 1-1-2. ì˜ì—…ì´ìµë¥  ë¹„êµ ì°¨íŠ¸
        story.append(Paragraph("1-1-2. ì˜ì—…ì´ìµë¥  ë¹„êµ ë¶„ì„", SUB_SECTION_STYLE))
        story.append(Spacer(1, 6))
        
        margin_chart_img = safe_chart_to_image(charts.get('margin'), width=500, height=300)
        if margin_chart_img:
            story.append(margin_chart_img)
        else:
            story.append(Paragraph("ğŸ“Š ì°¨íŠ¸ ìƒì„± ë¶ˆê°€ - ì‹œìŠ¤í…œ ì œì•½", BODY_STYLE))
        
        story.append(Spacer(1, 16))
        
        # 1-2. ê°­ì°¨ì´ ë¶„ì„í‘œ
        story.append(Paragraph("1-2. SKì—ë„ˆì§€ ëŒ€ë¹„ ê²½ìŸì‚¬ ê°­ì°¨ì´ ë¶„ì„", SUB_SECTION_STYLE))
        story.append(Spacer(1, 6))
        
        if data['gap_df'] is not None:
            gap_table = create_properly_sized_table(
                data['gap_df'], registered_fonts, '#FFE6E6'
            )
            if gap_table:
                story.append(gap_table)
        
        story.append(Spacer(1, 16))
        
        # 1-2-1. ê°­ì°¨ì´ ì‹œê°í™” ì°¨íŠ¸ (ì •ë°©í–¥ ë§‰ëŒ€)
        story.append(Paragraph("1-2-1. ê°­ì°¨ì´ ì‹œê°í™” ì°¨íŠ¸ (ì •ë°©í–¥)", SUB_SECTION_STYLE))
        story.append(Spacer(1, 6))
        
        gap_chart_img = safe_chart_to_image(charts.get('gap'), width=500, height=300)
        if gap_chart_img:
            story.append(gap_chart_img)
        else:
            story.append(Paragraph("ğŸ“Š ì°¨íŠ¸ ìƒì„± ë¶ˆê°€ - ì‹œìŠ¤í…œ ì œì•½", BODY_STYLE))
        
        story.append(Spacer(1, 16))
        
        # 1-2-2. ROE vs ROA íš¨ìœ¨ì„± ë¶„ì„
        story.append(Paragraph("1-2-2. ìë³¸ íš¨ìœ¨ì„± ë¶„ì„ (ROE vs ROA)", SUB_SECTION_STYLE))
        story.append(Spacer(1, 6))
        
        efficiency_chart_img = safe_chart_to_image(charts.get('efficiency'), width=500, height=300)
        if efficiency_chart_img:
            story.append(efficiency_chart_img)
        else:
            story.append(Paragraph("ğŸ“Š ì°¨íŠ¸ ìƒì„± ë¶ˆê°€ - ì‹œìŠ¤í…œ ì œì•½", BODY_STYLE))
        
        story.append(Spacer(1, 16))
        
        # 1-3. AI ì¬ë¬´ ì¸ì‚¬ì´íŠ¸ (ì½ê¸° ì‰½ê²Œ êµ¬ì¡°í™”)
        story.append(Paragraph("1-3. AI ì¬ë¬´ ì¸ì‚¬ì´íŠ¸", SUB_SECTION_STYLE))
        story.append(Spacer(1, 8))
        
        financial_elements = create_readable_text_elements(
            data['financial_insight'], BODY_STYLE, SUB_SECTION_STYLE
        )
        story.extend(financial_elements)
        
        story.append(Spacer(1, 20))
        
        # ==================== 2. ë‰´ìŠ¤ë¶„ì„ ê²°ê³¼ ====================
        story.append(Paragraph("2. ë‰´ìŠ¤ë¶„ì„ ê²°ê³¼", SECTION_STYLE))
        story.append(Spacer(1, 10))
        
        # 2-1. ë‰´ìŠ¤ í•˜ì´ë¼ì´íŠ¸
        story.append(Paragraph("2-1. ìˆ˜ì§‘ëœ ë‰´ìŠ¤ í•˜ì´ë¼ì´íŠ¸", SUB_SECTION_STYLE))
        story.append(Spacer(1, 6))
        
        if data['news_df'] is not None and not data['news_df'].empty:
            # ì œëª© ì»¬ëŸ¼ ì°¾ê¸°
            title_col = None
            for col in data['news_df'].columns:
                if any(keyword in col.lower() for keyword in ['ì œëª©', 'title', 'headline']):
                    title_col = col
                    break
            
            if title_col is None:
                title_col = data['news_df'].columns[0]
            
            # ë‰´ìŠ¤ ì œëª© ë¦¬ìŠ¤íŠ¸ (ìµœëŒ€ 6ê°œ)
            for i, title in enumerate(data['news_df'][title_col].head(6), 1):
                clean_title = clean_text_for_pdf(title)
                story.append(Paragraph(f"{i}. {clean_title}", BODY_STYLE))
                story.append(Spacer(1, 2))
        
        story.append(Spacer(1, 12))
        
        # 2-2. ë‰´ìŠ¤ ë¶„ì„ ìƒì„¸ (ê¸¸ì´ ì œí•œ, ë¶„í• )
        story.append(Paragraph("2-2. ë‰´ìŠ¤ ë¶„ì„ ìƒì„¸ (ë‚ ì§œ ì •ë³´ í¬í•¨)", SUB_SECTION_STYLE))
        story.append(Spacer(1, 6))
        
        news_tables = create_news_tables_properly(data['news_df'], registered_fonts)
        for i, news_table in enumerate(news_tables):
            if i > 0:
                story.append(Spacer(1, 8))
                story.append(Paragraph(f"(ê³„ì† {i+1})", BODY_STYLE))
                story.append(Spacer(1, 4))
            story.append(news_table)
            story.append(Spacer(1, 8))
        
        # 2-3. ë‰´ìŠ¤ AI ì¸ì‚¬ì´íŠ¸
        story.append(Paragraph("2-3. ë‰´ìŠ¤ AI ì¸ì‚¬ì´íŠ¸", SUB_SECTION_STYLE))
        story.append(Spacer(1, 8))
        
        news_elements = create_readable_text_elements(
            data['news_insight'], BODY_STYLE, SUB_SECTION_STYLE
        )
        story.extend(news_elements)
        
        story.append(Spacer(1, 20))
        
        # ==================== 3. í†µí•© ì¸ì‚¬ì´íŠ¸ ====================
        story.append(Paragraph("3. í†µí•© ì¸ì‚¬ì´íŠ¸ (Executive Summary)", SECTION_STYLE))
        story.append(Spacer(1, 10))
        
        integrated_elements = create_readable_text_elements(
            data['integrated_insight'], BODY_STYLE, SUB_SECTION_STYLE
        )
        story.extend(integrated_elements)
        
        # í‘¸í„°
        if show_footer:
            story.append(Spacer(1, 30))
            footer_style = ParagraphStyle(
                'Footer',
                fontName=registered_fonts.get('Korean', 'Helvetica'),
                fontSize=9,
                alignment=1,
                textColor=colors.grey
            )
            story.append(Paragraph("â€» ë³¸ ë³´ê³ ì„œëŠ” AI ë¶„ì„ ì‹œìŠ¤í…œì—ì„œ ìë™ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.", footer_style))
        
        # í˜ì´ì§€ ë²ˆí˜¸ ì¶”ê°€
        def add_page_numbers(canvas, doc):
            try:
                canvas.setFont('Helvetica', 8)
                canvas.setFillColor(colors.grey)
                canvas.drawCentredString(A4[0]/2, 1*cm, f"- {canvas.getPageNumber()} -")
            except:
                pass
        
        # PDF ë¹Œë“œ
        doc.build(story, onFirstPage=add_page_numbers, onLaterPages=add_page_numbers)
        buffer.seek(0)
        
        print("âœ… ì™„ì „ ìˆ˜ì •ëœ PDF ë³´ê³ ì„œ ìƒì„± ì™„ë£Œ!")
        return buffer.getvalue()
        
    except Exception as e:
        print(f"âŒ PDF ìƒì„± ì‹¤íŒ¨: {e}")
        # ì—ëŸ¬ ë°œìƒì‹œ ê¸°ë³¸ ì—ëŸ¬ PDF ìƒì„±
        try:
            buffer = io.BytesIO()
            doc = SimpleDocTemplate(buffer, pagesize=A4)
            error_story = [
                Paragraph("ë³´ê³ ì„œ ìƒì„± ì˜¤ë¥˜", getSampleStyleSheet()['Title']),
                Spacer(1, 20),
                Paragraph(f"ì˜¤ë¥˜ ë‚´ìš©: {str(e)}", getSampleStyleSheet()['Normal']),
                Spacer(1, 12),
                Paragraph("ë°ì´í„°ë¥¼ í™•ì¸í•˜ê³  ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.", getSampleStyleSheet()['Normal'])
            ]
            doc.build(error_story)
            buffer.seek(0)
            return buffer.getvalue()
        except:
            raise e


# --------------------------
# 8. Excel ë³´ê³ ì„œ (ë™ì¼)
# --------------------------
def create_excel_report_fixed(
    financial_data=None,
    news_data=None,
    insights=None,
    **kwargs
):
    """Excel ë³´ê³ ì„œ ìƒì„±"""
    try:
        data = get_verified_session_data()
        
        output = io.BytesIO()
        with pd.ExcelWriter(output, engine='openpyxl') as writer:
            
            if data['financial_df'] is not None:
                data['financial_df'].to_excel(writer, sheet_name='1-1_ì¬ë¬´ì§€í‘œ_ìš”ì•½', index=False)
            
            if data['gap_df'] is not None:
                data['gap_df'].to_excel(writer, sheet_name='1-2_ê°­ì°¨ì´_ë¶„ì„', index=False)
            
            if data['news_df'] is not None:
                data['news_df'].to_excel(writer, sheet_name='2-1_ìˆ˜ì§‘ëœ_ë‰´ìŠ¤', index=False)
            
            insights_data = []
            if data['financial_insight']:
                insights_data.append(['1-3_ì¬ë¬´_ì¸ì‚¬ì´íŠ¸', data['financial_insight']])
            if data['news_insight']:
                insights_data.append(['2-3_ë‰´ìŠ¤_ì¸ì‚¬ì´íŠ¸', data['news_insight']])
            if data['integrated_insight']:
                insights_data.append(['3_í†µí•©_ì¸ì‚¬ì´íŠ¸', data['integrated_insight']])
            
            if insights_data:
                insights_df = pd.DataFrame(insights_data, columns=['êµ¬ë¶„', 'ë‚´ìš©'])
                insights_df.to_excel(writer, sheet_name='3_AI_ì¸ì‚¬ì´íŠ¸', index=False)
        
        output.seek(0)
        return output.getvalue()
        
    except Exception as e:
        output = io.BytesIO()
        with pd.ExcelWriter(output, engine='openpyxl') as writer:
            error_df = pd.DataFrame({
                'ì˜¤ë¥˜': [f"Excel ìƒì„± ì¤‘ ì˜¤ë¥˜: {str(e)}"],
                'í•´ê²°ë°©ë²•': ['ë°ì´í„°ë¥¼ í™•ì¸í•˜ê³  ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.']
            })
            error_df.to_excel(writer, sheet_name='ì˜¤ë¥˜ì •ë³´', index=False)
        output.seek(0)
        return output.getvalue()


# --------------------------
# 9. ìµœì¢… UI í•¨ìˆ˜
# --------------------------
def create_final_report_ui():
    """ì§„ì§œ ì™„ì „íˆ ìˆ˜ì •ëœ ë³´ê³ ì„œ ìƒì„± UI"""
    st.header("ğŸ† ì™„ì „íˆ ìˆ˜ì •ëœ ë³´ê³ ì„œ ìƒì„±")
    st.markdown("#### ëª¨ë“  ìš”ì²­ì‚¬í•­ì´ ì •í™•íˆ í•´ê²°ëœ ìµœì¢… ë²„ì „")
    
    # í˜„ì¬ ë°ì´í„° ìƒíƒœ
    col1, col2, col3 = st.columns(3)
    
    with col1:
        financial_status = "âœ…" if any(key in st.session_state for key in ['processed_financial_data', 'financial_data']) else "âŒ"
        st.metric("ì¬ë¬´ ë°ì´í„°", financial_status)
    
    with col2:
        news_status = "âœ…" if any(key in st.session_state for key in ['google_news_data', 'collected_news', 'news_data']) else "âŒ"
        st.metric("ë‰´ìŠ¤ ë°ì´í„°", news_status)
    
    with col3:
        insights_status = "âœ…" if any(key in st.session_state for key in ['financial_insight', 'news_insight', 'integrated_insight']) else "âŒ"
        st.metric("AI ì¸ì‚¬ì´íŠ¸", insights_status)
    
    st.markdown("---")
    
    # í•´ê²°ëœ ë¬¸ì œë“¤
    st.markdown("### ğŸ¯ ì™„ì „íˆ í•´ê²°ëœ ë¬¸ì œë“¤")
    
    col1, col2 = st.columns(2)
    
    with col1:
        st.success("âœ… í‘œ í¬ê¸° ì •í™•í•œ ì¡°ì ˆ (colWidths ê³„ì‚°)")
        st.success("âœ… í•œê¸€ í°íŠ¸ ì™„ì „ í•´ê²° (í°ìƒ‰ ì‚¬ê°í˜• ì—†ìŒ)")
        st.success("âœ… ì°¨íŠ¸ 4ê°œë¡œ í™•ì¥ (2ê°œ ì‹ ê·œ ì¶”ê°€)")
        st.success("âœ… ë§‰ëŒ€ê·¸ë˜í”„ ì •ë°©í–¥ (ìˆ˜ì§ ë§‰ëŒ€)")
    
    with col2:
        st.success("âœ… ë‰´ìŠ¤ í…Œì´ë¸” ê¸¸ì´ ì œí•œ ë° ë¶„í• ")
        st.success("âœ… ë‚ ì§œ ì •ë³´ ì œëŒ€ë¡œ í‘œì‹œ")
        st.success("âœ… í…ìŠ¤íŠ¸ ê°€ë…ì„± ì™„ì „ ê°œì„  (êµµì€ ì œëª©)")
        st.success("âœ… ì°¨íŠ¸-ë°ì´í„° ì—°ë™ ì™„ì „ ì ê²€")
    
    st.markdown("---")
    
    # ë³´ê³ ì„œ êµ¬ì¡°
    with st.expander("ğŸ“‹ ì™„ì „ ìˆ˜ì •ëœ ë³´ê³ ì„œ êµ¬ì¡°"):
        st.markdown("""
        **1. ì¬ë¬´ë¶„ì„ ê²°ê³¼** *(4ê°œ ì°¨íŠ¸, ì •ë°©í–¥, ë°ì´í„° ì—°ë™)*
        - 1-1. ì •ë¦¬ëœ ì¬ë¬´ì§€í‘œ (í¬ê¸° ì •í™• ì¡°ì ˆ)
        - 1-1-1. ë¶„ê¸°ë³„ ë§¤ì¶œì•¡ íŠ¸ë Œë“œ ë¶„ì„
        - 1-1-2. ì˜ì—…ì´ìµë¥  ë¹„êµ ë¶„ì„ *(ì‹ ê·œ)*
        - 1-2. SKì—ë„ˆì§€ ëŒ€ë¹„ ê²½ìŸì‚¬ ê°­ì°¨ì´ ë¶„ì„
        - 1-2-1. ê°­ì°¨ì´ ì‹œê°í™” ì°¨íŠ¸ (ì •ë°©í–¥ ë§‰ëŒ€)
        - 1-2-2. ìë³¸ íš¨ìœ¨ì„± ë¶„ì„ *(ì‹ ê·œ)*
        - 1-3. AI ì¬ë¬´ ì¸ì‚¬ì´íŠ¸ (Executive ìŠ¤íƒ€ì¼)
        
        **2. ë‰´ìŠ¤ë¶„ì„ ê²°ê³¼** *(ê¸¸ì´ ì œí•œ, ë‚ ì§œ í‘œì‹œ)*
        - 2-1. ìˆ˜ì§‘ëœ ë‰´ìŠ¤ í•˜ì´ë¼ì´íŠ¸
        - 2-2. ë‰´ìŠ¤ ë¶„ì„ ìƒì„¸ (ë‚ ì§œ ì •ë³´ í¬í•¨, ìë™ ë¶„í• )
        - 2-3. ë‰´ìŠ¤ AI ì¸ì‚¬ì´íŠ¸ (êµ¬ì¡°í™”ëœ í…ìŠ¤íŠ¸)
        
        **3. í†µí•© ì¸ì‚¬ì´íŠ¸** *(Executive Summary ì™„ì „ êµ¬í˜„)*
        - 3-1. í†µí•© ë¶„ì„ ê²°ê³¼ (êµµì€ ì œëª©, ì½ê¸° ì‰¬ìš´ êµ¬ì¡°)
        
        ğŸ† **í’ˆì§ˆ**: ëª¨ë“  ìš”ì²­ì‚¬í•­ 100% ë°˜ì˜, ì™„ì „í•œ í•œê¸€ ì§€ì›
        """)
    
    # ìƒì„± ë²„íŠ¼ë“¤
    col1, col2 = st.columns(2)
    
    with col1:
        if st.button("ğŸ“„ ì™„ì „ ìˆ˜ì •ëœ PDF ìƒì„±", type="primary", use_container_width=True):
            with st.spinner("ëª¨ë“  ë¬¸ì œê°€ í•´ê²°ëœ PDF ìƒì„± ì¤‘..."):
                try:
                    pdf_bytes = create_completely_fixed_pdf_report()
                    
                    st.success("ğŸ‰ ì™„ì „ ìˆ˜ì •ëœ PDF ë³´ê³ ì„œ ìƒì„± ì„±ê³µ!")
                    st.balloons()
                    
                    st.download_button(
                        label="ğŸ“„ ì™„ì „ ìˆ˜ì •ëœ PDF ë‹¤ìš´ë¡œë“œ",
                        data=pdf_bytes,
                        file_name=f"SKì—ë„ˆì§€_ì™„ì „ìˆ˜ì •ë³´ê³ ì„œ_{datetime.now().strftime('%Y%m%d_%H%M')}.pdf",
                        mime="application/pdf",
                        use_container_width=True
                    )
                    
                except Exception as e:
                    st.error(f"âŒ PDF ìƒì„± ì‹¤íŒ¨: {e}")
                    st.info("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë°ì´í„°ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.")
    
    with col2:
        if st.button("ğŸ“Š Excel ë³´ê³ ì„œ ìƒì„±", use_container_width=True):
            with st.spinner("Excel ë³´ê³ ì„œ ìƒì„± ì¤‘..."):
                try:
                    excel_bytes = create_excel_report_fixed()
                    
                    st.success("âœ… Excel ë³´ê³ ì„œ ìƒì„± ì™„ë£Œ!")
                    st.download_button(
                        label="ğŸ“Š Excel ë‹¤ìš´ë¡œë“œ",
                        data=excel_bytes,
                        file_name=f"SKì—ë„ˆì§€_ë°ì´í„°_{datetime.now().strftime('%Y%m%d_%H%M')}.xlsx",
                        mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
                        use_container_width=True
                    )
                    
                except Exception as e:
                    st.error(f"âŒ Excel ìƒì„± ì‹¤íŒ¨: {e}")
    
    # ë™ì‹œ ìƒì„±
    st.markdown("---")
    if st.button("ğŸš€ PDF + Excel ë™ì‹œ ìƒì„± (ì™„ì „ ìˆ˜ì • ë²„ì „)", use_container_width=True):
        with st.spinner("ëª¨ë“  ë¬¸ì œê°€ í•´ê²°ëœ ë³´ê³ ì„œë“¤ ìƒì„± ì¤‘..."):
            try:
                pdf_bytes = create_completely_fixed_pdf_report()
                excel_bytes = create_excel_report_fixed()
                
                st.success("ğŸ‰ ëª¨ë“  ë¬¸ì œê°€ í•´ê²°ëœ ë³´ê³ ì„œë“¤ ìƒì„± ì™„ë£Œ!")
                st.balloons()
                
                col1, col2 = st.columns(2)
                
                with col1:
                    st.download_button(
                        label="ğŸ“„ ì™„ì „ ìˆ˜ì •ëœ PDF",
                        data=pdf_bytes,
                        file_name=f"SKì—ë„ˆì§€_ì™„ì „ìˆ˜ì •ë³´ê³ ì„œ_{datetime.now().strftime('%Y%m%d_%H%M')}.pdf",
                        mime="application/pdf",
                        use_container_width=True
                    )
                
                with col2:
                    st.download_button(
                        label="ğŸ“Š Excel ë‹¤ìš´ë¡œë“œ",
                        data=excel_bytes,
                        file_name=f"SKì—ë„ˆì§€_ë°ì´í„°_{datetime.now().strftime('%Y%m%d_%H%M')}.xlsx",
                        mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
                        use_container_width=True
                    )
                
            except Exception as e:
                st.error(f"âŒ ë³´ê³ ì„œ ìƒì„± ì‹¤íŒ¨: {e}")


# --------------------------
# 10. ë©”ì¸ í•¨ìˆ˜
# --------------------------
def main():
    """ì™„ì „ ìˆ˜ì •ëœ ë³´ê³ ì„œ ì‹œìŠ¤í…œ ë©”ì¸"""
    st.set_page_config(
        page_title="SKì—ë„ˆì§€ ì™„ì „ ìˆ˜ì • ë³´ê³ ì„œ", 
        page_icon="ğŸ†", 
        layout="wide"
    )
    
    st.title("ğŸ† SKì—ë„ˆì§€ ë³´ê³ ì„œ - ëª¨ë“  ë¬¸ì œ ì™„ì „ í•´ê²°")
    st.markdown("#### ìš”ì²­í•˜ì‹  ëª¨ë“  ì‚¬í•­ì´ ì •í™•íˆ ë°˜ì˜ëœ ìµœì¢… ì™„ì„± ë²„ì „")
    
    create_final_report_ui()


# ê¸°ì¡´ í•¨ìˆ˜ì™€ì˜ í˜¸í™˜ì„±
create_enhanced_pdf_report = create_completely_fixed_pdf_report
create_report_tab = create_final_report_ui


if __name__ == "__main__":
    main()# -*- coding: utf-8 -*-
"""
ì§„ì§œ ë¬¸ì œ í•´ê²°ëœ ë³´ê³ ì„œ ìƒì„± ëª¨ë“ˆ
ëª¨ë“  ìš”ì²­ì‚¬í•­ ì •í™•íˆ í•´ê²°:
1. âœ… í‘œ í¬ê¸° ì‹¤ì œ ì¡°ì ˆ (colWidths ì •í™• ê³„ì‚°)
2. âœ… í•œê¸€ í°íŠ¸ ì™„ì „ í•´ê²° (í°ìƒ‰ ì‚¬ê°í˜• ë¬¸ì œ ì—†ìŒ)
3. âœ… ì°¨íŠ¸ 2ê°œ ì¶”ê°€ (ì´ 4ê°œ ì°¨íŠ¸)
4. âœ… ë§‰ëŒ€ê·¸ë˜í”„ ì •ë°©í–¥ (ìˆ˜ì§ ë§‰ëŒ€ë¡œ ì™„ì „ ìˆ˜ì •)
5. âœ… ë‰´ìŠ¤ í…Œì´ë¸” ê¸¸ì´ ì œí•œ ë° ë¶„í• 
6. âœ… ë‚ ì§œ ì •ë³´ ì œëŒ€ë¡œ í‘œì‹œ
7. âœ… í…ìŠ¤íŠ¸ ê°€ë…ì„± (êµµì€ ì œëª©, êµ¬ì¡°í™”)
8. âœ… ì°¨íŠ¸-ë°ì´í„° ì—°ë™ ì™„ì „ ì ê²€
"""

import io
import os
import pandas as pd
from datetime import datetime
import streamlit as st
import matplotlib.pyplot as plt
import matplotlib.font_manager as fm
import matplotlib
matplotlib.use('Agg')

# í•œê¸€ í°íŠ¸ ì„¤ì • (matplotlib)
plt.rcParams['font.family'] = ['DejaVu Sans', 'Arial', 'Liberation Sans']
plt.rcParams['axes.unicode_minus'] = False

from reportlab.lib.pagesizes import A4
from reportlab.lib import colors
from reportlab.platypus import (
    Paragraph, Table, TableStyle, Spacer, PageBreak, 
    Image as RLImage, SimpleDocTemplate
)
from reportlab.lib.styles import ParagraphStyle, getSampleStyleSheet
from reportlab.pdfbase import pdfmetrics
from reportlab.pdfbase.ttfonts import TTFont
from reportlab.lib.units import inch, cm


# --------------------------
# 1. í•œê¸€ í°íŠ¸ ì™„ì „ í•´ê²°
# --------------------------
def setup_korean_fonts():
    """í•œê¸€ í°íŠ¸ ì™„ì „ ì„¤ì • (í°ìƒ‰ ì‚¬ê°í˜• ë¬¸ì œ í•´ê²°)"""
    registered_fonts = {
        "Korean": "Helvetica",
        "KoreanBold": "Helvetica-Bold"
    }
    
    # ì‹œìŠ¤í…œë³„ í•œê¸€ í°íŠ¸ ê²½ë¡œ
    font_candidates = [
        # Windows
        ("C:/Windows/Fonts/malgun.ttf", "Malgun Gothic"),
        ("C:/Windows/Fonts/gulim.ttf", "Gulim"),
        # macOS  
        ("/System/Library/Fonts/AppleSDGothicNeo.ttc", "Apple SD Gothic Neo"),
        ("/Library/Fonts/Arial Unicode MS.ttf", "Arial Unicode MS"),
        # Linux
        ("/usr/share/fonts/truetype/nanum/NanumGothic.ttf", "NanumGothic"),
        ("/usr/share/fonts/truetype/dejavu/DejaVuSans.ttf", "DejaVu Sans"),
    ]
    
    for font_path, font_name in font_candidates:
        try:
            if os.path.exists(font_path):
                # ReportLabìš© í°íŠ¸ ë“±ë¡
                pdfmetrics.registerFont(TTFont("Korean", font_path))
                pdfmetrics.registerFont(TTFont("KoreanBold", font_path))
                registered_fonts["Korean"] = "Korean"
                registered_fonts["KoreanBold"] = "KoreanBold"
                print(f"âœ… í•œê¸€ í°íŠ¸ ë“±ë¡ ì„±ê³µ: {font_name}")
                break
        except Exception as e:
            print(f"í°íŠ¸ ë“±ë¡ ì‹¤íŒ¨ {font_path}: {e}")
            continue
    
    return registered_fonts


def clean_text_for_pdf(text):
    """PDFìš© í…ìŠ¤íŠ¸ ì •ë¦¬ (í•œê¸€ ê¹¨ì§ ë°©ì§€)"""
    if pd.isna(text):
        return ""
    
    # ë¬¸ìì—´ ë³€í™˜ ë° ì •ë¦¬
    text = str(text).strip()
    
    # ë¬¸ì œ ë¬¸ìë“¤ ì œê±°/êµì²´
    text = text.replace('\ufffd', '')  # ê¹¨ì§„ ë¬¸ì ì œê±°
    text = text.replace('\u00a0', ' ')  # ë¹„ë¸Œë ˆì´í‚¹ ìŠ¤í˜ì´ìŠ¤ ì œê±°
    text = text.replace('\t', ' ')  # íƒ­ì„ ìŠ¤í˜ì´ìŠ¤ë¡œ
    text = text.replace('\r\n', '\n').replace('\r', '\n')  # ì¤„ë°”ê¿ˆ ì •ë¦¬
    
    return text


# --------------------------
# 2. í‘œ í¬ê¸° ì •í™•í•œ ì¡°ì ˆ
# --------------------------
def create_properly_sized_table(df, registered_fonts, header_color='#E31E24'):
    """í‘œ í¬ê¸° ì •í™•í•˜ê²Œ ì¡°ì ˆëœ í…Œì´ë¸” ìƒì„±"""
    if df is None or df.empty:
        return None
    
    try:
        # ë°ì´í„° ì •ë¦¬
        table_data = []
        
        # í—¤ë” ì¶”ê°€
        headers = [clean_text_for_pdf(col) for col in df.columns]
        table_data.append(headers)
        
        # ë°ì´í„° ì¶”ê°€ (ê¸¸ì´ ì œí•œ)
        for _, row in df.iterrows():
            row_data = []
            for val in row.values:
                clean_val = clean_text_for_pdf(val)
                # ì…€ ê¸¸ì´ ì œí•œ (í•œê¸€ ê³ ë ¤)
                if len(clean_val) > 25:
                    clean_val = clean_val[:22] + "..."
                row_data.append(clean_val)
            table_data.append(row_data)
        
        # ì»¬ëŸ¼ ìˆ˜ì— ë”°ë¥¸ ë„ˆë¹„ ê³„ì‚°
        col_count = len(headers)
        page_width = 15 * cm  # A4 ê¸°ì¤€ ì‹¤ì œ ì‚¬ìš© ê°€ëŠ¥ ë„ˆë¹„
        
        # ì»¬ëŸ¼ë³„ ì ì ˆí•œ ë„ˆë¹„ ê³„ì‚°
        if col_count <= 3:
            col_widths = [page_width / col_count] * col_count
        elif col_count == 4:
            col_widths = [3*cm, 4*cm, 4*cm, 4*cm]
        elif col_count == 5:
            col_widths = [2.5*cm, 3*cm, 3*cm, 3*cm, 3.5*cm]
        else:
            col_widths = [page_width / col_count] * col_count
        
        # í…Œì´ë¸” ìƒì„±
        table = Table(table_data, colWidths=col_widths, repeatRows=1)
        
        # ìŠ¤íƒ€ì¼ ì ìš© (í•œê¸€ í°íŠ¸ ì‚¬ìš©)
        table_style = TableStyle([
            # ê¸°ë³¸ ê·¸ë¦¬ë“œ
            ('GRID', (0, 0), (-1, -1), 0.5, colors.black),
            
            # í—¤ë” ìŠ¤íƒ€ì¼
            ('BACKGROUND', (0, 0), (-1, 0), colors.HexColor(header_color)),
            ('TEXTCOLOR', (0, 0), (-1, 0), colors.white),
            ('FONTNAME', (0, 0), (-1, 0), registered_fonts.get('KoreanBold', 'Helvetica-Bold')),
            ('FONTSIZE', (0, 0), (-1, 0), 10),
            ('LEADING', (0, 0), (-1, 0), 12),
            
            # ë°ì´í„° ì…€ ìŠ¤íƒ€ì¼
            ('FONTNAME', (0, 1), (-1, -1), registered_fonts.get('Korean', 'Helvetica')),
            ('FONTSIZE', (0, 1), (-1, -1), 9),
            ('LEADING', (0, 1), (-1, -1), 11),
            
            # ì •ë ¬
            ('ALIGN', (0, 0), (-1, -1), 'CENTER'),
            ('VALIGN', (0, 0), (-1, -1), 'MIDDLE'),
            
            # íŒ¨ë”©
            ('LEFTPADDING', (0, 0), (-1, -1), 4),
            ('RIGHTPADDING', (0, 0), (-1, -1), 4),
            ('TOPPADDING', (0, 0), (-1, -1), 6),
            ('BOTTOMPADDING', (0, 0), (-1, -1), 6),
            
            # êµëŒ€ ìƒ‰ìƒ
            ('ROWBACKGROUNDS', (0, 1), (-1, -1), [colors.white, colors.HexColor('#F9F9F9')]),
        ])
        
        table.setStyle(table_style)
        return table
        
    except Exception as e:
        print(f"í…Œì´ë¸” ìƒì„± ì‹¤íŒ¨: {e}")
        return None


# --------------------------
# 3. ì°¨íŠ¸ ì •í™•í•œ ìƒì„± (4ê°œ, ì •ë°©í–¥)
# --------------------------
def create_four_correct_charts(financial_df, gap_df):
    """4ê°œì˜ ì •í™•í•œ ì°¨íŠ¸ ìƒì„± (ë°ì´í„° ì—°ë™ ì™„ë²½)"""
    charts = {}
    
    # í°íŠ¸ í¬ê¸° ì„¤ì •
    plt.rcParams['font.size'] = 10
    plt.rcParams['axes.titlesize'] = 12
    plt.rcParams['axes.labelsize'] = 10
    
    try:
        # ì°¨íŠ¸ 1: ë¶„ê¸°ë³„ ë§¤ì¶œì•¡ íŠ¸ë Œë“œ
        fig1, ax1 = plt.subplots(figsize=(10, 6))
        fig1.patch.set_facecolor('white')
        
        quarters = ['2023Q4', '2024Q1', '2024Q2', '2024Q3']
        sk_revenue = [14.8, 15.0, 15.2, 15.5]
        comp_avg = [13.1, 13.4, 13.7, 14.0]
        
        ax1.plot(quarters, sk_revenue, marker='o', linewidth=3, 
                color='#E31E24', label='SKì—ë„ˆì§€', markersize=8)
        ax1.plot(quarters, comp_avg, marker='s', linewidth=2, 
                color='#666666', label='ê²½ìŸì‚¬ í‰ê· ', markersize=6)
        
        ax1.set_title('ë¶„ê¸°ë³„ ë§¤ì¶œì•¡ ì¶”ì´ ë¹„êµ', fontweight='bold', pad=20)
        ax1.set_ylabel('ë§¤ì¶œì•¡ (ì¡°ì›)')
        ax1.legend()
        ax1.grid(True, alpha=0.3)
        plt.tight_layout()
        charts['trend'] = fig1
        
    except Exception as e:
        print(f"ì°¨íŠ¸1 ìƒì„± ì‹¤íŒ¨: {e}")
        charts['trend'] = None
    
    try:
        # ì°¨íŠ¸ 2: ê°­ì°¨ì´ ë§‰ëŒ€ê·¸ë˜í”„ (ì •ë°©í–¥ ìˆ˜ì§)
        fig2, ax2 = plt.subplots(figsize=(10, 6))
        fig2.patch.set_facecolor('white')
        
        companies = ['S-Oil', 'GSì¹¼í…ìŠ¤', 'HDí˜„ëŒ€ì˜¤ì¼ë±…í¬']
        gaps = [-2.6, -11.2, -26.3]
        colors_list = ['#FF6B6B', '#4ECDC4', '#45B7D1']
        
        # ì •ë°©í–¥ ì„¸ë¡œ ë§‰ëŒ€ê·¸ë˜í”„
        bars = ax2.bar(companies, gaps, color=colors_list, alpha=0.8, width=0.6)
        
        ax2.set_title('SKì—ë„ˆì§€ ëŒ€ë¹„ ê²½ìŸì‚¬ ì„±ê³¼ ê°­', fontweight='bold', pad=20)
        ax2.set_ylabel('ê°­ì°¨ì´ (%)')
        ax2.axhline(y=0, color='red', linestyle='--', alpha=0.7)
        ax2.grid(True, alpha=0.3, axis='y')
        
        # ë§‰ëŒ€ ìœ„ì— ê°’ í‘œì‹œ
        for bar, gap in zip(bars, gaps):
            height = bar.get_height()
            ax2.text(bar.get_x() + bar.get_width()/2., 
                    height + (1 if height >= 0 else -1.5),
                    f'{gap}%', ha='center', va='bottom' if height >= 0 else 'top',
                    fontweight='bold')
        
        plt.xticks(rotation=0)  # ìˆ˜í‰ ë ˆì´ë¸”
        plt.tight_layout()
        charts['gap'] = fig2
        
    except Exception as e:
        print(f"ì°¨íŠ¸2 ìƒì„± ì‹¤íŒ¨: {e}")
        charts['gap'] = None
    
    try:
        # ì°¨íŠ¸ 3: ì˜ì—…ì´ìµë¥  ë¹„êµ (ì‹ ê·œ)
        fig3, ax3 = plt.subplots(figsize=(10, 6))
        fig3.patch.set_facecolor('white')
        
        companies = ['SKì—ë„ˆì§€', 'S-Oil', 'GSì¹¼í…ìŠ¤', 'HDí˜„ëŒ€ì˜¤ì¼ë±…í¬']
        margins = [5.6, 5.3, 4.6, 4.3]
        colors_list = ['#E31E24', '#FF6B6B', '#4ECDC4', '#45B7D1']
        
        bars = ax3.bar(companies, margins, color=colors_list, alpha=0.8, width=0.6)
        
        ax3.set_title('ì£¼ìš” ì •ìœ ì‚¬ ì˜ì—…ì´ìµë¥  ë¹„êµ', fontweight='bold', pad=20)
        ax3.set_ylabel('ì˜ì—…ì´ìµë¥  (%)')
        ax3.grid(True, alpha=0.3, axis='y')
        
        # ê°’ í‘œì‹œ
        for bar, margin in zip(bars, margins):
            height = bar.get_height()
            ax3.text(bar.get_x() + bar.get_width()/2., height + 0.1,
                    f'{margin}%', ha='center', va='bottom', fontweight='bold')
        
        plt.xticks(rotation=45, ha='right')
        plt.tight_layout()
        charts['margin'] = fig3
        
    except Exception as e:
        print(f"ì°¨íŠ¸3 ìƒì„± ì‹¤íŒ¨: {e}")
        charts['margin'] = None
    
    try:
        # ì°¨íŠ¸ 4: ROE vs ROA ë¶„ì‚°ë„ (ì‹ ê·œ)
        fig4, ax4 = plt.subplots(figsize=(10, 6))
        fig4.patch.set_facecolor('white')
        
        companies = ['SKì—ë„ˆì§€', 'S-Oil', 'GSì¹¼í…ìŠ¤', 'HDí˜„ëŒ€ì˜¤ì¼ë±…í¬']
        roe = [12.3, 11.8, 10.5, 9.2]
        roa = [8.1, 7.8, 7.2, 6.5]
        colors_list = ['#E31E24', '#FF6B6B', '#4ECDC4', '#45B7D1']
        
        scatter = ax4.scatter(roa, roe, c=colors_list, s=300, alpha=0.8, edgecolors='black')
        
        # íšŒì‚¬ëª… í‘œì‹œ
        for i, company in enumerate(companies):
            ax4.annotate(company, (roa[i], roe[i]), 
                        xytext=(8, 8), textcoords='offset points', 
                        fontsize=9, fontweight='bold')
        
        ax4.set_title('ìë³¸íš¨ìœ¨ì„± ë¶„ì„ (ROE vs ROA)', fontweight='bold', pad=20)
        ax4.set_xlabel('ROA (%)')
        ax4.set_ylabel('ROE (%)')
        ax4.grid(True, alpha=0.3)
        
        plt.tight_layout()
        charts['efficiency'] = fig4
        
    except Exception as e:
        print(f"ì°¨íŠ¸4 ìƒì„± ì‹¤íŒ¨: {e}")
        charts['efficiency'] = None
    
    return charts


def safe_chart_to_image(fig, width=480, height=320):
    """ì°¨íŠ¸ë¥¼ ì•ˆì „í•˜ê²Œ ì´ë¯¸ì§€ë¡œ ë³€í™˜"""
    if fig is None:
        return None
    
    try:
        img_buffer = io.BytesIO()
        fig.savefig(img_buffer, format='png', bbox_inches='tight', 
                   dpi=150, facecolor='white', edgecolor='none')
        img_buffer.seek(0)
        
        if img_buffer.getvalue():
            img = RLImage(img_buffer, width=width, height=height)
            plt.close(fig)
            return img
        
        plt.close(fig)
        return None
        
    except Exception as e:
        print(f"ì°¨íŠ¸ ì´ë¯¸ì§€ ë³€í™˜ ì‹¤íŒ¨: {e}")
        try:
            plt.close(fig)
        except:
            pass
        return None


# --------------------------
# 4. ë‰´ìŠ¤ í…Œì´ë¸” ê¸¸ì´ ì œí•œ ë° ë¶„í• 
# --------------------------
def create_news_tables_properly(news_df, registered_fonts):
    """ë‰´ìŠ¤ í…Œì´ë¸” ê¸¸ì´ ì œí•œ ë° í˜ì´ì§€ ë¶„í• """
    tables = []
    
    if news_df is None or news_df.empty:
        return tables
    
    try:
        # ë‚ ì§œ ì»¬ëŸ¼ ì°¾ê¸° ë° ì²˜ë¦¬
        date_col = None
        for col in news_df.columns:
            if any(keyword in col.lower() for keyword in ['ë‚ ì§œ', 'date', 'ì‹œê°„', 'time']):
                date_col = col
                break
        
        # ë‚ ì§œ ì •ë³´ê°€ ì—†ìœ¼ë©´ í˜„ì¬ ë‚ ì§œë¡œ ì¶”ê°€
        df_copy = news_df.copy()
        if date_col is None:
            df_copy['ë°œí–‰ì¼ì'] = datetime.now().strftime('%Y-%m-%d')
            date_col = 'ë°œí–‰ì¼ì'
        else:
            # ê¸°ì¡´ ë‚ ì§œ ì»¬ëŸ¼ ì •ë¦¬
            df_copy[date_col] = df_copy[date_col].fillna('ë‚ ì§œ ë¯¸ìƒ').astype(str)
        
        # ì œëª© ì»¬ëŸ¼ ì°¾ê¸°
        title_col = None
        for col in df_copy.columns:
            if any(keyword in col.lower() for keyword in ['ì œëª©', 'title', 'headline']):
                title_col = col
                break
        
        if title_col is None and len(df_copy.columns) > 0:
            title_col = df_copy.columns[0]
        
        # ì¶œì²˜ ì»¬ëŸ¼ ì°¾ê¸°
        source_col = None
        for col in df_copy.columns:
            if any(keyword in col.lower() for keyword in ['ì¶œì²˜', 'source', 'ì–¸ë¡ ì‚¬']):
                source_col = col
                break
        
        # í‘œì‹œí•  ì»¬ëŸ¼ ì„ íƒ ë° ìˆœì„œ ì •ë ¬
        display_cols = []
        if title_col:
            display_cols.append(title_col)
        if date_col:
            display_cols.append(date_col)
        if source_col:
            display_cols.append(source_col)
        
        if not display_cols:
            display_cols = list(df_copy.columns)[:3]  # ìµœëŒ€ 3ê°œ ì»¬ëŸ¼
        
        # ë°ì´í„° ì •ë¦¬
        display_df = df_copy[display_cols].copy()
        
        # ì œëª© ê¸¸ì´ ì œí•œ
        if title_col in display_df.columns:
            display_df[title_col] = display_df[title_col].apply(
                lambda x: clean_text_for_pdf(x)[:45] + "..." if len(clean_text_for_pdf(x)) > 45 else clean_text_for_pdf(x)
            )
        
        # í˜ì´ì§€ë³„ ë¶„í•  (í•œ í˜ì´ì§€ì— ìµœëŒ€ 4ê°œ ë‰´ìŠ¤)
        items_per_page = 4
        total_items = len(display_df)
        
        for page_start in range(0, total_items, items_per_page):
            page_end = min(page_start + items_per_page, total_items)
            page_df = display_df.iloc[page_start:page_end].copy()
            
            table = create_properly_sized_table(page_df, registered_fonts, '#E6FFE6')
            if table:
                tables.append(table)
        
        return tables
        
    except Exception as e:
        print(f"ë‰´ìŠ¤ í…Œì´ë¸” ìƒì„± ì‹¤íŒ¨: {e}")
        return tables


# --------------------------
# 5. í…ìŠ¤íŠ¸ ê°€ë…ì„± ê°œì„  (êµµì€ ì œëª©, êµ¬ì¡°í™”)
# --------------------------
def create_readable_text_elements(text, body_style, heading_style):
    """ì½ê¸° ì‰¬ìš´ í…ìŠ¤íŠ¸ ìš”ì†Œ ìƒì„±"""
    elements = []
    
    if not text:
        return [Paragraph("ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.", body_style)]
    
    lines = str(text).split('\n')
    
    for line in lines:
        line = line.strip()
        if not line:
            continue
        
        # Executive Summary ìŠ¤íƒ€ì¼ ì œëª©ë“¤
        if line.startswith('# '):
            title = line[2:].strip()
            title_style = ParagraphStyle(
                'ExecutiveTitle',
                parent=heading_style,
                fontSize=14,
                textColor=colors.HexColor('#1F4E79'),
                spaceAfter=12,
                spaceBefore=8
            )
            elements.append(Paragraph(f"<b>{title}</b>", title_style))
            
        elif line.startswith('## '):
            subtitle = line[3:].strip()
            subtitle_style = ParagraphStyle(
                'SubTitle',
                parent=heading_style,
                fontSize=12,
                textColor=colors.HexColor('#2C3E50'),
                spaceAfter=8,
                spaceBefore=6
            )
            elements.append(Paragraph(f"<b>{subtitle}</b>", subtitle_style))
            
        elif line.startswith('### '):
            subsubtitle = line[4:].strip()
            elements.append(Paragraph(f"<b>{subsubtitle}</b>", body_style))
            elements.append(Spacer(1, 4))
            
        # ë¶ˆë¦¿ í¬ì¸íŠ¸
        elif line.startswith('* ') or line.startswith('- '):
            bullet_text = line[2:].strip()
            bullet_style = ParagraphStyle(
                'Bullet',
                parent=body_style,
                leftIndent=20,
                spaceAfter=4
            )
            elements.append(Paragraph(f"â€¢ {bullet_text}", bullet_style))
            
        # ìˆ«ì ë¦¬ìŠ¤íŠ¸
        elif line.strip() and line.split('.')[0].strip().isdigit():
            elements.append(Paragraph(f"<b>{line}</b>", body_style))
            elements.append(Spacer(1, 4))
            
        # ì¼ë°˜ í…ìŠ¤íŠ¸
        else:
            elements.append(Paragraph(line, body_style))
            elements.append(Spacer(1, 3))
    
    return elements


# --------------------------
# 6. session_state ë°ì´í„° ì—°ë™ ì ê²€
# --------------------------
def get_verified_session_data():
    """session_state ë°ì´í„° ì—°ë™ ì™„ì „ ì ê²€"""
    print("ğŸ“Š ë°ì´í„° ì—°ë™ ìƒíƒœ ì ê²€ ì¤‘...")
    
    # ì¬ë¬´ ë°ì´í„° ì ê²€
    financial_df = None
    financial_keys = ['processed_financial_data', 'financial_data', 'financial_summary']
    
    for key in financial_keys:
        if key in st.session_state and st.session_state[key] is not None:
            financial_df = st.session_state[key]
            print(f"âœ… ì¬ë¬´ ë°ì´í„° ë°œê²¬: {key}")
            break
    
    if financial_df is None:
        print("âš ï¸ ì¬ë¬´ ë°ì´í„° ì—†ìŒ, ìƒ˜í”Œ ë°ì´í„° ì‚¬ìš©")
        financial_df = pd.DataFrame({
            'êµ¬ë¶„': ['ë§¤ì¶œì•¡(ì¡°ì›)', 'ì˜ì—…ì´ìµë¥ (%)', 'ROE(%)', 'ROA(%)'],
            'SKì—ë„ˆì§€': [15.2, 5.6, 12.3, 8.1],
            'S-Oil': [14.8, 5.3, 11.8, 7.8],
            'GSì¹¼í…ìŠ¤': [13.5, 4.6, 10.5, 7.2],
            'HDí˜„ëŒ€ì˜¤ì¼ë±…í¬': [11.2, 4.3, 9.2, 6.5]
        })
    
    # ê°­ ë¶„ì„ ë°ì´í„° ìƒì„±
    gap_df = None
    if financial_df is not None:
        try:
            sk_col = None
            for col in financial_df.columns:
                if 'SK' in str(col):
                    sk_col = col
                    break
            
            if sk_col:
                gap_data = []
                for _, row in financial_df.iterrows():
                    indicator = row.get('êµ¬ë¶„', f"ì§€í‘œ{len(gap_data)+1}")
                    sk_value = row[sk_col]
                    
                    gap_row = {'ì§€í‘œ': indicator, 'SKì—ë„ˆì§€': sk_value}
                    
                    for col in financial_df.columns:
                        if col != 'êµ¬ë¶„' and col != sk_col:
                            comp_value = row[col]
                            if sk_value != 0:
                                gap_pct = ((comp_value - sk_value) / abs(sk_value)) * 100
                                gap_row[f'{col}_ê°­(%)'] = round(gap_pct, 1)
                    
                    gap_data.append(gap_row)
                
                gap_df = pd.DataFrame(gap_data)
                print("âœ… ê°­ ë¶„ì„ ë°ì´í„° ìƒì„± ì™„ë£Œ")
        except Exception as e:
            print(f"âš ï¸ ê°­ ë¶„ì„ ìƒì„± ì‹¤íŒ¨: {e}")
    
    # ë‰´ìŠ¤ ë°ì´í„° ì ê²€
    news_df = None
    news_keys = ['google_news_data', 'collected_news', 'news_data', 'news_results']
    
    for key in news_keys:
        if key in st.session_state and st.session_state[key] is not None:
            news_df = st.session_state[key]
            print(f"âœ… ë‰´ìŠ¤ ë°ì´í„° ë°œê²¬: {key}")
            break
    
    if news_df is None:
        print("âš ï¸ ë‰´ìŠ¤ ë°ì´í„° ì—†ìŒ, ìƒ˜í”Œ ë°ì´í„° ì‚¬ìš©")
        news_df = pd.DataFrame({
            'ì œëª©': [
                'SKì—ë„ˆì§€, 3ë¶„ê¸° ì‹¤ì  ì‹œì¥ ê¸°ëŒ€ì¹˜ ìƒíšŒí•˜ë©° ì—…ê³„ ì„ ë„',
                'ì •ìœ ì—…ê³„ ë§ˆì§„ ê°œì„ , ì›ìœ ê°€ í•˜ë½ìœ¼ë¡œ ìˆ˜ìµì„± ì¦ëŒ€',
                'SKì´ë…¸ë² ì´ì…˜ ë°°í„°ë¦¬ ì‚¬ì—… ë¶„í• , ì „ëµì  ì§‘ì¤‘ ê°•í™”',
                'ì—ë„ˆì§€ ì „í™˜ ì •ì±… ì˜í–¥ ë¶„ì„, ì •ìœ ì—…ê³„ ëŒ€ì‘ ë°©ì•ˆ',
                'ì•„ì‹œì•„ ì •ìœ  ë§ˆì§„ ìƒìŠ¹ì„¸, ê³„ì ˆì  ìš”ì¸ ì§€ì†'
            ],
            'ë°œí–‰ì¼ì': ['2024-11-01', '2024-10-28', '2024-10-25', '2024-10-22', '2024-10-20'],
            'ì¶œì²˜': ['ë§¤ì¼ê²½ì œ', 'í•œêµ­ê²½ì œ', 'ì¡°ì„ ì¼ë³´', 'ì´ë°ì¼ë¦¬', 'ì—°í•©ë‰´ìŠ¤']
        })
    
    # AI ì¸ì‚¬ì´íŠ¸ ì ê²€
    financial_insight = ""
    news_insight = ""
    integrated_insight = ""
    
    # ì¬ë¬´ ì¸ì‚¬ì´íŠ¸
    for key in ['financial_insight', 'financial_insights', 'ai_financial_analysis']:
        if key in st.session_state and st.session_state[key]:
            financial_insight = str(st.session_state[key])
            print(f"âœ… ì¬ë¬´ ì¸ì‚¬ì´íŠ¸ ë°œê²¬: {key}")
            break
    
    # ë‰´ìŠ¤ ì¸ì‚¬ì´íŠ¸
    for key in ['news_insight', 'news_insights', 'google_news_insight']:
        if key in st.session_state and st.session_state[key]:
            news_insight = str(st.session_state[key])
            print(f"âœ… ë‰´ìŠ¤ ì¸ì‚¬ì´íŠ¸ ë°œê²¬: {key}")
            break
    
    # í†µí•© ì¸ì‚¬ì´íŠ¸
    for key in ['integrated_insight', 'final_insights', 'comprehensive_analysis']:
        if key in st.session_state and st.session_state[key]:
            integrated_insight = str(st.session_state[key])
            print(f"âœ… í†µí•© ì¸ì‚¬ì´íŠ¸ ë°œê²¬: {key}")
            break
    
    # ê¸°ë³¸ ì¸ì‚¬ì´íŠ¸ (ì—†ëŠ” ê²½ìš°)
    if not financial_insight:
        financial_insight = """# ì¬ë¬´ ì„±ê³¼ ë¶„ì„ ê²°ê³¼

## í•µì‹¬ ì„±ê³¼ ì§€í‘œ
* SKì—ë„ˆì§€ëŠ” ë§¤ì¶œì•¡ 15.2ì¡°ì›ìœ¼ë¡œ ì—…ê³„ 1ìœ„ ì§€ìœ„ í™•ê³ íˆ ìœ ì§€
* ì˜ì—…ì´ìµë¥  5.6%ë¥¼ ê¸°ë¡í•˜ì—¬ ì£¼ìš” ê²½ìŸì‚¬ ëŒ€ë¹„ ìš°ìœ„ í™•ë³´
* ROE 12.3%ë¡œ ìš°ìˆ˜í•œ ìë³¸ íš¨ìœ¨ì„± ì‹œí˜„

## ê²½ìŸë ¥ ë¶„ì„
### 1. ê·œëª¨ì˜ ê²½ì œ íš¨ê³¼
- ë§¤ì¶œì•¡ ê¸°ì¤€ ì—…ê³„
