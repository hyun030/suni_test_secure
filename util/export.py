# -*- coding: utf-8 -*-
"""
SKì—ë„ˆì§€ ë³´ê³ ì„œ ìƒì„±ê¸° - ê¸°ë³¸ë¶€í„° ë‹¤ì‹œ ì‹œì‘
PDF ì˜¤ë¥˜ ì™„ì „ í•´ê²°ì„ ìœ„í•œ ë‹¨ê³„ì  ì ‘ê·¼
"""

import io
import os
import pandas as pd
from datetime import datetime
import streamlit as st

# ReportLabë§Œ ê¸°ë³¸ ê¸°ëŠ¥ìœ¼ë¡œ
try:
    from reportlab.pdfgen import canvas
    from reportlab.lib.pagesizes import A4
    REPORTLAB_OK = True
    print("âœ… ReportLab ê¸°ë³¸ ë¡œë“œ")
except ImportError:
    REPORTLAB_OK = False
    print("âŒ ReportLab ì—†ìŒ")


def create_basic_canvas_pdf():
    """ê°€ì¥ ê¸°ë³¸ì ì¸ Canvas PDF ìƒì„±"""
    if not REPORTLAB_OK:
        return b"ReportLab not available"
    
    try:
        print("ğŸ“„ ê¸°ë³¸ Canvas PDF ìƒì„±...")
        
        buffer = io.BytesIO()
        c = canvas.Canvas(buffer, pagesize=A4)
        width, height = A4
        
        # ì œëª©
        c.setFont("Helvetica-Bold", 16)
        c.drawString(50, height-50, "SK Energy Analysis Report")
        
        # ë‚ ì§œ
        c.setFont("Helvetica", 12)
        c.drawString(50, height-80, f"Date: {datetime.now().strftime('%Y-%m-%d %H:%M')}")
        
        # êµ¬ë¶„ì„ 
        c.line(50, height-100, width-50, height-100)
        
        # ë‚´ìš©
        y = height-130
        c.setFont("Helvetica-Bold", 14)
        c.drawString(50, y, "1. Financial Analysis")
        
        y -= 30
        c.setFont("Helvetica", 10)
        lines = [
            "1-1. Financial Indicators",
            "     - Revenue: Data from financial_data",
            "     - Operating Margin: Data from financial_data", 
            "     - ROE: Data from financial_data",
            "",
            "1-2. Visual Analysis",
            "     - Quarterly trend chart",
            "     - Bar chart comparison",
            "",
            "1-3. Financial AI Insights",
            "     - AI analysis results"
        ]
        
        for line in lines:
            c.drawString(70, y, line)
            y -= 15
        
        y -= 20
        c.setFont("Helvetica-Bold", 14)
        c.drawString(50, y, "2. News Analysis")
        
        y -= 30
        c.setFont("Helvetica", 10)
        news_lines = [
            "2-1. News Status",
            "     - Recent news data",
            "",
            "2-2. News AI Insights", 
            "     - Market trend analysis"
        ]
        
        for line in news_lines:
            c.drawString(70, y, line)
            y -= 15
        
        y -= 20
        c.setFont("Helvetica-Bold", 14)
        c.drawString(50, y, "3. Integrated Insights")
        
        y -= 30
        c.setFont("Helvetica", 10)
        c.drawString(70, y, "Comprehensive analysis combining financial and news data")
        
        y -= 30
        c.setFont("Helvetica-Bold", 14)
        c.drawString(50, y, "4. Strategic Recommendations")
        
        y -= 30
        c.setFont("Helvetica", 10)
        rec_lines = [
            "4-1. Short-term strategy",
            "4-2. Medium-term strategy", 
            "4-3. Long-term strategy"
        ]
        
        for line in rec_lines:
            c.drawString(70, y, line)
            y -= 15
        
        # í‘¸í„°
        c.setFont("Helvetica", 8)
        c.drawString(50, 50, "Generated by AI Analysis System")
        
        c.save()
        
        pdf_data = buffer.getvalue()
        buffer.close()
        
        print(f"âœ… ê¸°ë³¸ PDF ì™„ë£Œ: {len(pdf_data)} bytes")
        
        # ë°”ì´íŠ¸ ê²€ì¦
        if len(pdf_data) < 100:
            print("âŒ PDF ë„ˆë¬´ ì‘ìŒ")
            return None
            
        # PDF ì‹œì‘ í™•ì¸
        if not pdf_data.startswith(b'%PDF'):
            print("âŒ PDF í˜•ì‹ ì˜¤ë¥˜")
            return None
            
        return pdf_data
        
    except Exception as e:
        print(f"âŒ ê¸°ë³¸ PDF ì‹¤íŒ¨: {e}")
        return None


def create_enhanced_pdf_report(
    financial_data=None,
    news_data=None,
    insights=None,
    show_footer=True,
    report_target="SKì´ë…¸ë² ì´ì…˜ ê²½ì˜ì§„",
    report_author="AI ë¶„ì„ ì‹œìŠ¤í…œ",
    **kwargs
):
    """ë©”ì¸ í•¨ìˆ˜ - ì¼ë‹¨ ê¸°ë³¸ PDFë§Œ"""
    
    print("ğŸ“„ PDF ìƒì„± ìš”ì²­ ë°›ìŒ...")
    print(f"financial_data: {type(financial_data)}")
    print(f"news_data: {type(news_data)}")
    print(f"insights: {type(insights)}")
    
    # ì¼ë‹¨ ê°€ì¥ ê¸°ë³¸ì ì¸ PDFë¶€í„°
    basic_pdf = create_basic_canvas_pdf()
    
    if basic_pdf:
        print("âœ… ê¸°ë³¸ PDF ì„±ê³µ")
        return basic_pdf
    else:
        print("âŒ ê¸°ë³¸ PDF ì‹¤íŒ¨")
        
        # ìˆ˜ë™ PDF ë°”ì´íŠ¸ ìƒì„±
        try:
            print("ğŸ“„ ìˆ˜ë™ PDF ë°”ì´íŠ¸ ìƒì„±...")
            
            pdf_content = b"""%PDF-1.4
1 0 obj
<< /Type /Catalog /Pages 2 0 R >>
endobj
2 0 obj  
<< /Type /Pages /Kids [3 0 R] /Count 1 >>
endobj
3 0 obj
<< /Type /Page /Parent 2 0 R /MediaBox [0 0 612 792] /Contents 4 0 R /Resources << /Font << /F1 5 0 R >> >> >>
endobj
4 0 obj
<< /Length 200 >>
stream
BT
/F1 12 Tf
50 750 Td
(SK Energy Report) Tj
0 -20 Td
(Generated: """ + datetime.now().strftime('%Y-%m-%d').encode('ascii') + b""") Tj
0 -40 Td
(1. Financial Analysis) Tj
0 -20 Td
(2. News Analysis) Tj  
0 -20 Td
(3. Integrated Insights) Tj
0 -20 Td
(4. Strategic Recommendations) Tj
ET
endstream
endobj
5 0 obj
<< /Type /Font /Subtype /Type1 /BaseFont /Helvetica >>
endobj
xref
0 6
0000000000 65535 f
0000000010 00000 n
0000000053 00000 n
0000000110 00000 n
0000000246 00000 n
0000000498 00000 n
trailer
<< /Size 6 /Root 1 0 R >>
startxref
565
%%EOF"""
            
            print(f"âœ… ìˆ˜ë™ PDF ìƒì„±: {len(pdf_content)} bytes")
            return pdf_content
            
        except Exception as e:
            print(f"âŒ ìˆ˜ë™ PDF ì‹¤íŒ¨: {e}")
            return "PDF generation completely failed".encode('utf-8')


def create_excel_report(
    financial_data=None,
    news_data=None,
    insights=None,
    **kwargs
):
    """Excel ë³´ê³ ì„œ ìƒì„±"""
    try:
        buffer = io.BytesIO()
        
        # ê¸°ë³¸ ë°ì´í„°
        data = {
            'SKì—ë„ˆì§€': [15.2, 5.6, 12.3],
            'S-Oil': [14.8, 5.3, 11.8]
        }
        
        df = pd.DataFrame(data, index=['ë§¤ì¶œì•¡(ì¡°ì›)', 'ì˜ì—…ì´ìµë¥ (%)', 'ROE(%)'])
        
        with pd.ExcelWriter(buffer, engine='openpyxl') as writer:
            df.to_excel(writer, sheet_name='ì¬ë¬´ë¶„ì„')
        
        buffer.seek(0)
        return buffer.getvalue()
        
    except Exception as e:
        print(f"Excel ì‹¤íŒ¨: {e}")
        return None


# ë©”ì¸ í…ŒìŠ¤íŠ¸
if __name__ == "__main__":
    print("ğŸ§ª ê¸°ë³¸ PDF í…ŒìŠ¤íŠ¸...")
    
    # 1. ê¸°ë³¸ í…ŒìŠ¤íŠ¸
    basic_test = create_basic_canvas_pdf()
    if basic_test:
        with open("basic_test.pdf", "wb") as f:
            f.write(basic_test)
        print("âœ… basic_test.pdf ìƒì„±ë¨")
    
    # 2. ë©”ì¸ í•¨ìˆ˜ í…ŒìŠ¤íŠ¸
    main_test = create_enhanced_pdf_report()
    if main_test:
        with open("main_test.pdf", "wb") as f:
            f.write(main_test)
        print("âœ… main_test.pdf ìƒì„±ë¨")
    
    print("í…ŒìŠ¤íŠ¸ ì™„ë£Œ - íŒŒì¼ë“¤ì„ ì§ì ‘ ì—´ì–´ë³´ì„¸ìš”!")
